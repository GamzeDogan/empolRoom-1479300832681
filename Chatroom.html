<!doctype html>
<html>
<head>
<title>Empol</title>
</head>
<link rel="stylesheet" href="https://empolchat.mybluemix.net/style.css">
<body>
	<div class="serverPW">
		<label id="labelServerPw"><b>Server password</b></label>
		<form id="serverLogin" action="">
			<input id= "serverPassword" type="password" class= "serverPwClass" placeholder=" Password"/>
			<input id= "serverPwButton" type="submit" value= "Send"/>
		</form>
	</div>
		<label id="serverWrongPWD">Wrong credentials! Please try again.</label>

	<div class = "loginPW">
		<label id="loginLabel"><b>Login</b></label>
		<form id ="loginEvent" action="">
			<input id="username" type="text" class="usClass" placeholder=" Username" /><p/>
			<input id= "password" type="password" class="pwClass" placeholder=" Password"/>
			<input id="login" type="submit" value="Log In" />
			<!-- Link um sich zu registrieren -->
			
		</form>
		<form id="signUpLinkForm" action="">
			<button id ="signUpLink">Sign up?</button>
		</form>
	</div>
	<label id="accountError" style="font: 15px Arial; color: red; margin-top: 5px">Wrong credentials! Please try again.</label>

	<div class="signUpDiv">
		<label id="signUpLabel"><b>Sign Up</b></label>
		<form id ="signUpEvent" action="">
			<input id="usernameSignUp" type="text" class="usernameSignUpClass" placeholder=" Username" />
			<input id= "passwordSignUp" type="password" class="pwdSignUpClass" placeholder=" Password"/>
			<input id= "passwordVerification" type="password" class="pwdVfcSignUpClass" placeholder=" Re-enter password"/>
			<input id="signUp" type="submit" value="Sign Up" />
			<label id="signUpError" style="font: 15px Arial; color: red; margin-top: 5px"><center>Please fill in the form completely!</center></label>
			<label id="signUpPWDError" style="font: 15px Arial; color: red; margin-top: 5px"><center>Passwords are not similar. Try again!</center></label>

		</form>
		<div class="uploadAvatarDiv">
		<!--<img id="avatar" width="100" height="100" src="http://empolchat.mybluemix.net/image/avatar.jpg"/>-->
		</div>
		<div class="uploadAvatar">
			<form id="uploadAvatarIcon" method="post" enctype="multipart/form-data">
				<input id="mediaAvatar" type="file" accept=".png, .jpg, .jpeg" value="Datei Upload"/>
			</form>
			<form id="takePictureEvent" method="">
				<input id="takePicture" type="submit" value="Take a picture" />
			</form>
		</div>
	</div>
	
	<div class="takePictureDiv">
		<label id="captureLabel"><b><center> Capture a photo </center></b> </label>
		<form id="takePictureEvent" action="">
			<center><video id="video" width="250" height="200"></video><p/>
			<a href="#" id="capture">Take a photo</a> <br> 
			<canvas id="canvas" width="250" height="200"></canvas></center>
		</form>
		<form id="savePictureEvent" action=""> 
			<center><input id="savePicture" type="submit" value="Save this picture"/></center>
		</form>
		<br>
		<form id="backToSignUp" action=""> 
			<center><input id="backtoSignUpId" type="submit" value="Back to SignUp "/></center>
		</form>
	
	</div>
	
	<div class="sideDiv">
		<h1><center>Empol</center></h1>	
		<!--<form id= "signinEvent" action="">
			<label id="usernameError" style="font: 15px Arial; color: red; margin-top: 5px">Username is already taken.</label>
			<label id="unvalidError" style="font: 15px Arial; color: red; margin-top: 5px">Unvalid! Please try again.</label>
			<label id="successfullyNotification" style="font: 15px Arial; color: red; margin-top: 5px">You are signed in successfully! Please Login.</label>
		</form>-->
		<div class="chatAvatar"></div>
		
		<div id="onlineUser"></div>
	</div>

	<div id="upload">
		<form id="sendMedia" method="post" enctype="multipart/form-data">
			<label id="uploadLabel" for="media" class="btn">Upload File</label> <input
				id="media" type="file" disabled="disabled" value="Datei Upload" ="visibility: hidden"/>
		</form>
	</div>
	<div id="messagesDiv" >
		<ul id="messages"></ul>
	</div>
	
	<div class="box" >
		<form id="sendEvent" action="">
			<input  class="msgClass" placeholder="write something..." />
			<button id="send" disabled="disabled">Send</button>
		</form>
	</div>
	<script src="/socket.io/socket.io.js"></script>
	<script src="https://code.jquery.com/jquery-1.11.1.js"></script>

	<script>
	
    if (document.location.protocol == "http:"){
        document.location='https://empolchat.mybluemix.net/'; 
	}
	
	var socket = io();
	$('.serverPW').show();
	$('#send').prop('disabled', true);
	$('#media').prop('disabled', true);
	var imageURL;
	var streamer;
	var imageAvatarUploaded;
		
		$('#serverLogin').submit(function(){
			if($('.serverPwClass').val() != ""){
				var password = $('#serverPassword').val();
				socket.emit('pwdForServerEmpolChatRoom', {password: password}, function(data){
					if(data == true){
						$('.serverPW').hide();
						$('#serverPassword').val('');
						$('#accountError').hide();
						$('.loginPW').show();
					} else {
						$('#serverWrongPWD').show();
						$('#serverPassword').val('');
						console.log("Falsches PWD");
					}
				});	
			}
			return false;
		});

		$('#loginEvent').submit(function() {
			var username = $('#username').val();
			var password = $('#password').val();
			if (($('.usClass').val() == "" && $('.pwClass').val() == "") | ($('.usClass').val() == "" || $('.pwClass').val() == "")){
				$('#accountError').show();
			} else {
				console.log("username clientside " + username);
				console.log("pwd clientside " + password);
				socket.emit('logInUser',{username : username, password : password}, function(data) {
					if (data == false) {
						$('#accountError').show();				
					} else if(data == true) {
						socket.username = username;
						socket.password = password;
						$('#accountError').hide();
						$('#messages').show();
						$('#onlineUser').show();
						$('#send').prop('disabled',false);
						$('#media').prop('disabled',false);
					}
				});
			}
			
			//sign up values deleted not login
			$('#usernameSignUp').val('');
			$('#passwordSignUp').val('');
			$('#passwordVerification').val('');
			return false;
		});
		
		$('#signUpLinkForm').submit(function() {
			$('.loginPW').hide();
			$('#username').val('');
			$('#password').val('');
			$('.signUpDiv').show();	
			$('.uploadAvatarDiv').show();
			$('.uploadAvatar').show();
			return false;
		});
		
		$('#signUpEvent').submit(function(e){
			if(($('.usernameSignUpClass').val() != "" && $('.pwdSignUpClass').val() != "" && $('.pwdVfcSignUpClass').val() != "")
			| ($('.usernameSignUpClass').val() != "" || $('.pwdSignUpClass').val() != "" || $('.pwdVfcSignUpClass').val() != "")){				
				var username = $('#usernameSignUp').val();
				var password = $('#passwordSignUp').val();
				var passwordVerification = $('#passwordVerification').val();
				
				if(password == passwordVerification){
					//Schauen die Div Klasse leer ist oder nicht (Bild vorhanden oder nicht)
					var imageUploaded = imageAvatarUploaded;
					var imageChat;
					
					if(imageURL != undefined){
						imageChat = imageURL;
					}
					else if(imageUploaded != undefined) {
						imageChat = imageUploaded;
					}
					socket.emit('signUp', {username: username, password: password, passwordVerification: passwordVerification, image : imageChat}, function(data){
						if(data){
							socket.username = $('#usernameSignUp').val();
							socket.password = $('#passwordSignUp').val();
						} else {
							console.log("ERROR client-side");
						}
					});	
				} else {
					console.log("Passwort Re enter falsch");
					$('#signUpPWDError').show();
					
				}
			} else {
				console.log("Alle Zeilen ausfüllen");
				//Alle Zeilen ausfüllen! erstn dann Sign up
				$('#signUpError').show();
			}
			return false;
		});
		
		$('#takePictureEvent').submit(function(){
			$('.signUpDiv').hide();
			$('.uploadAvatarDiv').hide();
			$('.uploadAvatar').hide();
			$('.takePictureDiv').show();
			
			var video = document.getElementById('video');
			var canvas = document.getElementById('canvas');
			var context = canvas.getContext('2d');
			var vendorUrl = window.URL || window.webkitURL;
			
			context.clearRect(0, 0, canvas.width, canvas.height);

			navigator.getMedia = 	navigator.getUserMedia || 
									navigator.webkitGetUserMedia || 
									navigator.mozGetUserMedia ||
									navigator.msGetUserMedia;
									
			navigator.getMedia({
				video: true,
				audio: false}, 
				function(stream){
					streamer = stream;
					video.src = vendorUrl.createObjectURL(stream);
					video.play();
				}, 
				function(error){
					console.log("Error: Video stream");
				}
			);
			
			document.getElementById('capture').addEventListener('click', function(){
				context.drawImage(video, 0, 0, 250, 200);
				imageURL = canvas.toDataURL('image/jpeg');	
				console.log(imageURL);
			});
			return false;
		});
		
		$('#savePictureEvent').submit(function(){
			var vid = $('#video').get(0);
			vid.pause();
			streamer.getVideoTracks()[0].stop();

			var empty = "";
			$('.uploadAvatarDiv').html(empty);
			$('.uploadAvatarDiv').append('<img width="120" height="120" src="' + imageURL + '"/>');
			$('.signUpDiv').show();
			$('.uploadAvatarDiv').show();
			$('.uploadAvatar').show();
			$('.takePictureDiv').hide();
			
			return false;
		});
		
		$('#uploadAvatarIcon').on('change', function(e) {
			var media = e.originalEvent.target.files[0];
			var reader = new FileReader();
			reader.onload = function(evt) {
				socket.emit('avatarUpload', {
					result : evt.target.result
				});
			};
			// Read in the image file as a data URL.
			reader.readAsDataURL(media);
		});
		
		socket.on('avatarUploaded', function(image) {
		imageAvatarUploaded = image.result;
		var empty = "";
		$('.uploadAvatarDiv').html(empty);
		$('.uploadAvatarDiv').append('<img width="100" height="100" src="' + image.result + '"/>');
		});
		
		socket.on('signInSuccessfully', function(data) {
			$('.loginPW').show();
			$('.signUpDiv').hide();	
			$('.uploadAvatarDiv').hide();
			$('.uploadAvatar').hide();
		});
		
		socket.on('logInUserEmit', function(logIn) {
			$('.loginPW').hide();
			$('.sideDiv').show();
			$('#upload').show();
			$('#messagesDiv').show();
			$('.box').show();
			$('.chatAvatar').show();
			
			$('.chatAvatar').append('<img width="100" height="100" src="' + logIn.image + '"/>');
			
			var time = new Date(logIn.timezone);
			$('#messages').append(
					$('<li>').append(
							$('<i>').text(
									'['
											+ time.getFullYear()
											+ '/'
											+ (time.getMonth() + 1)
											+ '/'
											+ time.getDate()
											+ ' '
											+ (time.getHours() < 10 ? '0'
													+ time.getHours() : time
													.getHours())
											+ ':'
											+ (time.getMinutes() < 10 ? '0'
													+ time.getMinutes() : time
													.getMinutes()) + '] '),
							$('<b>').text(
									logIn.username),
							$('<strong style="color:#20B2AA">').text(
								' has joined the chatroom: '),$('<b>').text('home')));
		});
		
		/*
		This method listens to the server and 
		it fills the onlineUser div with the array which contains the online users.
		 */
		socket.on('usernames', function(data) {
			var empty = '<b>Online user / Room:</b>';
			for (i = 0; i < data.userList.length; i++) {
				empty = empty + "<br/>- " + data.userList[i] + " / " + data.roomList[data.userList[i]];
			}
			$('#onlineUser').html(empty);
		});
		
		/*
		This method listens to the server and gets the username and throws a
		message when the user clicks to  the logout button
		After the logout the send and the upload button will be disabled again.
		 */
		socket.on('logOutUserEmit', function(logOut) {
			var time = new Date(logOut.timezone);
			$('#messages').append(
					$('<li>').append(
							$('<i>').text(
									'['
											+ time.getFullYear()
											+ '/'
											+ (time.getMonth() + 1)
											+ '/'
											+ time.getDate()
											+ ' '
											+ (time.getHours() < 10 ? '0'
													+ time.getHours() : time
													.getHours())
											+ ':'
											+ (time.getMinutes() < 10 ? '0'
													+ time.getMinutes() : time
													.getMinutes()) + '] '),
							$('<b>').text(
									logOut.name ), $('<strong style="color:#20B2AA;">').text(" has left the chatroom.")));
		});
		
		/*
		This is the eventhandler for the send button. 
		If the message isn't empty then it sends the message with the username to the server.
		Then input of the message will be deleted.
		 */
		$('#sendEvent').submit(function() {
			if ($('.msgClass').val() != "") {
				var username = $('#username').val();
				var textmessage = $('#message').val();
				socket.emit('chat message', {
					text : textmessage,
					name : username
				});
				$('#message').val('');
				return false;
			} else {
				$('#message').val('');
				return false;
			}
		});
		
		/*
		This method listens to the server and appends the messages with the current date 
		 */
		socket.on('chat message', function(msg) {
			if(socket.username != undefined){
			time = new Date(msg.timezone);
			$('#messages').append(
					$('<li>').append(
							$('<span>').text(
									'['
											+ time.getFullYear()
											+ '/'
											+ (time.getMonth() + 1)
											+ '/'
											+ time.getDate()
											+ ' '
											+ (time.getHours() < 10 ? '0'
													+ time.getHours() : time
													.getHours())
											+ ':'
											+ (time.getMinutes() < 10 ? '0'
													+ time.getMinutes() : time
													.getMinutes()) + ']'),
							$('<b>').text(' ' + msg.name + ': '),
							$('<span>').text(msg.text)));
			}
		});
		
		/*
		This method listens to the sever and goes trough the method if the user wants to write a private message.
		It appends the the private with the current date.
		 */
		socket
				.on('private message', function(msg) {
							time = new Date(msg.timezone);
							$('#messages').append($('<li>').append($('<span>').text(
																			'['
																					+ time
																							.getFullYear()
																					+ '/'
																					+ (time
																							.getMonth() + 1)
																					+ '/'
																					+ time
																							.getDate()
																					+ ' '
																					+ (time
																							.getHours() < 10 ? '0'
																							+ time
																									.getHours()
																							: time
																									.getHours())
																					+ ':'
																					+ (time
																							.getMinutes() < 10 ? '0'
																							+ time
																									.getMinutes()
																							: time
																									.getMinutes())
																					+ '] '),
															$('<b>')
																	.text(
																			' private chat between '
																					+ msg.name
																					+ ' and '
																					+ msg.destinationName
																					+ ': '),
															$('<span>').text(
																	msg.text)));
						});
		
		/*
		This method appends a message if the user wants to write a private message to a user sho doesn't exists.
		 */
		socket
				.on(
						'UnvalidNameError',
						function(msg) {
							time = new Date(msg.timezone);
							$('#messages')
									.append(
											$('<li>')
													.append(
															$('<span>')
																	.text(
																			'['
																					+ time
																							.getFullYear()
																					+ '/'
																					+ (time
																							.getMonth() + 1)
																					+ '/'
																					+ time
																							.getDate()
																					+ ' '
																					+ (time
																							.getHours() < 10 ? '0'
																							+ time
																									.getHours()
																							: time
																									.getHours())
																					+ ':'
																					+ (time
																							.getMinutes() < 10 ? '0'
																							+ time
																									.getMinutes()
																							: time
																									.getMinutes())
																					+ '] '),
															$(
																	'<strong style="color:red">')
																	.text(
																			' This username doesnt exist. Choose an online user!'),
															$('<span>').text(
																	msg.text)));
						});
		
		/*It goes through this method if the user clicks to the upload button
		 Getting the name of a file before it is uploaded with the originalEvent.
		 A file reader will be created and the event onload will be triggert read operation is completed successfully.
		 Then it sends the result to the server.
		 */
		$('#sendMedia').on('change', function(e) {
			if(socket.username != undefined){
			var media = e.originalEvent.target.files[0];
			var reader = new FileReader();
			reader.onload = function(evt) {
				var username = $('#username').val();
				socket.emit('userImage', {
					result : evt.target.result,
					username : username
				});
			};
			// Read in the image file as a data URL.
			reader.readAsDataURL(media);
			}
		});
		
		/*
		 This method appends the image in the messages div.
		 It gets the image from the server.
		 */
		socket.on('userImageEmit', function(image) {
			if(socket.username != undefined){
			time = new Date(image.timezone);
			$('#messages').append(
					$('<li>').append(
							$('<span>').text(
									'[' + time.getFullYear() + '/'
											+ (time.getMonth() + 1) + '/'
											+ time.getDate() + ' '
											+ time.getHours() + ':'
											+ time.getMinutes() + '] '),
							$('<b> ').text(
									' ' + image.username), $('<strong style="color:#20B2AA;">').text(' has sent an image:'),
							'</p> <img width="220" height="190" src="' + image.result + '"/>'));
			$('#media').val('');
			}
		});
		
		/*
		 Here all users will see a notification that a room is created.
		 */
		socket.on('chatroomBroadcast', function(msg) {
			if(socket.username != undefined){
				time = new Date(msg.timezone);
				$('#messages')
				.append(
						$('<li>')
								.append(
										$('<span>')
												.text(
														'['
																+ time
																		.getFullYear()
																+ '/'
																+ (time
																		.getMonth() + 1)
																+ '/'
																+ time
																		.getDate()
																+ ' '
																+ (time
																		.getHours() < 10 ? '0'
																		+ time
																				.getHours()
																		: time
																				.getHours())
																+ ':'
																+ (time
																		.getMinutes() < 10 ? '0'
																		+ time
																				.getMinutes()
																		: time
																				.getMinutes())
																+ '] '),
										$('<b>')
												.text(msg.name),
												$('<strong style="color:#20B2AA;">').text(' created the room: '),
												$('<b>').text(msg.chatroom )));
		}
		});
		
		/*
		 After you created/joined a chatroom you get this notification.
		 */
		socket.on('emptyChat', function(msg){
			$('#messages').empty();
			var time = new Date(msg.timezone);
			$('#messages').append($('<li>').append($('<i>').text(
									'['
											+ time.getFullYear()
											+ '/'
											+ (time.getMonth() + 1)
											+ '/'
											+ time.getDate()
											+ ' '
											+ (time.getHours() < 10 ? '0'
													+ time.getHours() : time
													.getHours())
											+ ':'
											+ (time.getMinutes() < 10 ? '0'
													+ time.getMinutes() : time
													.getMinutes()) + '] '),
							$('<strong style="color:#20B2AA;">').text(
									" You have joined the chatroom " ),
									$('<b>').text(msg.chatroom ),
									$('<strong style="color:#20B2AA;">').text(". Room password: "),
									$('<b>').text(msg.pwd)));
		});
		
		/*
		 If a room exists already, you get this notification.
		 */
		socket.on('roomExistsWarning', function(msg){ 
			if(socket.username != undefined){ 
				time = new Date(msg.timezone); 
				$('#messages').append( $('<li>').append( $('<span>') 
						.text( '[' + time .getFullYear() + '/' + (time .getMonth() + 1) + '/' + time .getDate() + ' ' 
						         + (time .getHours() < 10 ? '0' + time .getHours() : time .getHours()) + ':' 
						         + (time .getMinutes() < 10 ? '0' + time .getMinutes() : time .getMinutes()) + '] '), 
						         $('<strong style="color:red">') .text('The room " '+ msg.chatroom + ' "is already created! Please try again."'))); } 
			});
		
		/*
		 If a user changed a room all users get a notification, that the user changes the room.
		 */
		socket.on('userChangedRoom', function (msg){ 
			if(socket.username != undefined){ 
				time = new Date(msg.timezone); $('#messages').append( $('<li>').append( $('<span>') 
						.text( '[' + time .getFullYear() + '/' + (time .getMonth() + 1) + '/' + time .getDate() + ' ' 
						         + (time .getHours() < 10 ? '0' + time .getHours() : time .getHours()) + ':' 
						         + (time .getMinutes() < 10 ? '0' + time .getMinutes() : time .getMinutes()) + '] '), 
						         $('<b>') .text( msg.name ),
						         $('<strong style="color:#20B2AA;">') .text(' changed into the room: '), 
						         $('<b>').text(msg.chatroom))); } });
		
		
		/*
		 You get this notification, if you entered a wrong password for a specific room.
		 */
		socket.on('wrongPWforRoom', function(msg){ 
			if(socket.username != undefined){ 
				time = new Date(msg.timezone); $('#messages') .append( $('<li>') .append( $('<span>') 
						.text( '[' + time .getFullYear() + '/' + (time .getMonth() + 1) + '/' + time .getDate() 
						         + ' ' + (time .getHours() < 10 ? '0' + time .getHours() : time .getHours()) + ':' 
						         + (time .getMinutes() < 10 ? '0' + time .getMinutes() : time .getMinutes()) + '] '), 
						         $('<strong style="color:red">') 
						         .text('You entered the wrong password for the room "'+ msg.chatroom + '"'))); 
		}});
		
		/*
		 If a room doesnt exist, you will get this notification.
		 */
		socket.on('roomDoesntExistsWarning', function(msg){ 
			if(socket.username != undefined){ 
				time = new Date(msg.timezone); $('#messages') .append( $('<li>') .append( $('<span>') 
						.text( '[' + time .getFullYear() + '/' + (time .getMonth() + 1) + '/' + time .getDate() 
						         + ' ' + (time .getHours() < 10 ? '0' + time .getHours() : time .getHours()) + ':' 
						         + (time .getMinutes() < 10 ? '0' + time .getMinutes() : time .getMinutes()) + ']'), 
						         $('<strong style="color:red">') .text('The room " '+ msg.chatroom + ' doesnt exist!'))); } });
		
		/*
		This method is for disabling our bottons.
		 */
		jQuery.fn.extend({ 
			disable : function(state) {
				return this.each(function() {
					this.disabled = state;
				});
			}
		}); 
	</script>
</body>
</html>